name: Deploy Static Demo to GitHub Pages

on:
  # ExÃ©cution manuelle
  workflow_dispatch:
  
  # ExÃ©cution automatique chaque lundi Ã  2h du matin
  schedule:
    - cron: '0 2 * * 1'
  
  # Optionnel : exÃ©cution sur push vers main (Ã  commenter si non souhaitÃ©)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'web/**'

# Permissions nÃ©cessaires pour dÃ©ployer sur GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Ã‰viter les dÃ©ploiements concurrents
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: web
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Generate demo data
        run: |
          echo "ðŸŽ² Generating demo data..."
          node scripts/generate-demo-data.js
          
          echo "âœ… Data generated successfully"
          echo "ðŸ“Š Events: $(jq '.totalCount' web/public/static-data/events.json)"
          echo "ðŸ“š Catalogs: $(jq '.totalCount' web/public/static-data/catalogs.json)"
          echo "ðŸ”’ Locks: $(jq '.totalCount' web/public/static-data/locks.json)"
          ls -lh web/public/static-data/

      - name: Build frontend with static data
        working-directory: web
        run: npm run build:static

      - name: Add demo banner to index.html
        run: |
          # Ajouter un bandeau indiquant qu'il s'agit d'une dÃ©mo statique
          sed -i 's/<body>/<body><div style="background:#fbbf24;color:#000;padding:8px;text-align:center;font-weight:bold;">ðŸ“Š Static Demo - Data updated weekly - Last update: '"$(date -u +%Y-%m-%d)"'<\/div>/' web/dist/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'web/dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ github.repository_owner }}.github.io/tracker/" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "- **Events**: $(jq -r '.totalCount // 0' web/public/static-data/events.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Catalogs**: $(jq -r '.totalCount // 0' web/public/static-data/catalogs.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Locks**: $(jq -r '.totalCount // 0' web/public/static-data/locks.json)" >> $GITHUB_STEP_SUMMARY
