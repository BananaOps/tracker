import { useState } from 'react'
import { type VulnerabilitySeverity, type VulnerabilitySummary, type VulnerabilitySource } from '../types/api'
import { Shield, AlertTriangle, Info, Plus, Save, X, Edit, ExternalLink, Trash2 } from 'lucide-react'

interface VulnerabilityManagerProps {
  vulnerabilitySummary?: VulnerabilitySummary
  onChange: (summary?: VulnerabilitySummary) => void
}

export default function VulnerabilityManager({ 
  vulnerabilitySummary, 
  onChange 
}: VulnerabilityManagerProps) {
  const [isEditing, setIsEditing] = useState(false)
  const [sources, setSources] = useState<VulnerabilitySource[]>(
    vulnerabilitySummary?.sources || []
  )

  // Calculate aggregated counts from sources
  const calculateAggregatedCounts = (sources: VulnerabilitySource[]) => {
    return sources.reduce((acc, source) => ({
      criticalCount: acc.criticalCount + source.criticalCount,
      highCount: acc.highCount + source.highCount,
      mediumCount: acc.mediumCount + source.mediumCount,
      lowCount: acc.lowCount + source.lowCount,
      infoCount: acc.infoCount + source.infoCount,
      totalCount: acc.totalCount + source.totalCount
    }), {
      criticalCount: 0,
      highCount: 0,
      mediumCount: 0,
      lowCount: 0,
      infoCount: 0,
      totalCount: 0
    })
  }

  const handleSave = () => {
    const aggregated = calculateAggregatedCounts(sources)
    const updatedSummary: VulnerabilitySummary = {
      ...aggregated,
      lastUpdated: new Date().toISOString(),
      sources: sources
    }
    onChange(updatedSummary)
    setIsEditing(false)
  }

  const handleCancel = () => {
    setSources(vulnerabilitySummary?.sources || [])
    setIsEditing(false)
  }

  const handleRemove = () => {
    onChange(undefined)
    setIsEditing(false)
  }

  const addNewSource = () => {
    const newSource: VulnerabilitySource = {
      name: '',
      type: 'sca',
      url: '',
      criticalCount: 0,
      highCount: 0,
      mediumCount: 0,
      lowCount: 0,
      infoCount: 0,
      totalCount: 0,
      lastScan: '',
      scanVersion: '',
      description: ''
    }
    setSources([...sources, newSource])
  }

  const updateSource = (index: number, updatedSource: VulnerabilitySource) => {
    const newSources = [...sources]
    newSources[index] = updatedSource
    setSources(newSources)
  }

  const removeSource = (index: number) => {
    setSources(sources.filter((_, i) => i !== index))
  }

  const getSeverityColor = (severity: VulnerabilitySeverity): string => {
    switch (severity) {
      case 'critical':
        return '#dc2626' // red-600
      case 'high':
        return '#ea580c' // orange-600
      case 'medium':
        return '#d97706' // amber-600
      case 'low':
        return '#65a30d' // lime-600
      case 'info':
        return '#2563eb' // blue-600
      default:
        return '#6b7280' // gray-500
    }
  }

  const getSeverityIcon = (severity: VulnerabilitySeverity) => {
    switch (severity) {
      case 'critical':
      case 'high':
        return <AlertTriangle className="w-3 h-3" />
      case 'medium':
      case 'low':
        return <Shield className="w-3 h-3" />
      case 'info':
        return <Info className="w-3 h-3" />
      default:
        return <Shield className="w-3 h-3" />
    }
  }

  const getSeverityLabel = (severity: VulnerabilitySeverity): string => {
    switch (severity) {
      case 'critical':
        return 'Critical'
      case 'high':
        return 'High'
      case 'medium':
        return 'Medium'
      case 'low':
        return 'Low'
      case 'info':
        return 'Info'
      default:
        return 'Unknown'
    }
  }

  const formatDate = (dateString?: string): string => {
    if (!dateString) return 'Never'
    try {
      return new Date(dateString).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
      })
    } catch {
      return 'Invalid'
    }
  }

  const getSourceTypeLabel = (type: string): string => {
    const labels: Record<string, string> = {
      'sast': 'SAST',
      'sca': 'SCA',
      'container': 'Container',
      'iac': 'IaC',
      'secrets': 'Secrets',
      'license': 'License',
      'malware': 'Malware'
    }
    return labels[type] || type.toUpperCase()
  }

  const getSourceTypeColor = (type: string): string => {
    const colors: Record<string, string> = {
      'sast': '#8b5cf6', // violet
      'sca': '#06b6d4', // cyan
      'container': '#10b981', // emerald
      'iac': '#f59e0b', // amber
      'secrets': '#ef4444', // red
      'license': '#6366f1', // indigo
      'malware': '#dc2626' // red-600
    }
    return colors[type] || '#6b7280'
  }

  // Calculate aggregated counts for display
  const aggregatedCounts = vulnerabilitySummary?.sources ? 
    calculateAggregatedCounts(vulnerabilitySummary.sources) : 
    {
      criticalCount: vulnerabilitySummary?.criticalCount || 0,
      highCount: vulnerabilitySummary?.highCount || 0,
      mediumCount: vulnerabilitySummary?.mediumCount || 0,
      lowCount: vulnerabilitySummary?.lowCount || 0,
      infoCount: vulnerabilitySummary?.infoCount || 0,
      totalCount: vulnerabilitySummary?.totalCount || 0
    }

  if (!vulnerabilitySummary && !isEditing) {
    return (
      <div className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
        <div className="p-4 border-b border-gray-200 dark:border-gray-700">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center space-x-2">
            <Shield className="w-5 h-5" />
            <span>Vulnerability Summary</span>
          </h3>
        </div>
        <div className="p-4">
          <div className="text-center py-6">
            <Shield className="w-8 h-8 text-gray-300 dark:text-gray-600 mx-auto mb-2" />
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-3">
              No vulnerability data
            </p>
            <button
              onClick={() => setIsEditing(true)}
              className="btn-primary text-sm flex items-center space-x-2"
            >
              <Plus className="w-4 h-4" />
              <span>Add Sources</span>
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
      <div className="p-4 border-b border-gray-200 dark:border-gray-700">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center space-x-2">
            <Shield className="w-5 h-5" />
            <span>Vulnerability Summary</span>
            {vulnerabilitySummary?.sources && vulnerabilitySummary.sources.length > 0 && (
              <span className="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-2 py-1 rounded-full">
                {vulnerabilitySummary.sources.length} source{vulnerabilitySummary.sources.length > 1 ? 's' : ''}
              </span>
            )}
          </h3>
          {!isEditing && vulnerabilitySummary && (
            <div className="flex items-center space-x-2">
              <button
                onClick={() => setIsEditing(true)}
                className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors"
                title="Edit vulnerability sources"
              >
                <Edit className="w-4 h-4" />
              </button>
              <button
                onClick={handleRemove}
                className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                title="Remove vulnerability data"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
          )}
        </div>
      </div>

      <div className="p-4">
        {isEditing ? (
          <div className="space-y-4">
            {/* Sources Management */}
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <h4 className="text-sm font-medium text-gray-900 dark:text-gray-100">
                  Vulnerability Sources
                </h4>
                <button
                  onClick={addNewSource}
                  className="btn-primary text-xs flex items-center space-x-1"
                >
                  <Plus className="w-3 h-3" />
                  <span>Add Source</span>
                </button>
              </div>

              {sources.map((source, index) => (
                <div key={index} className="border border-gray-200 dark:border-gray-600 rounded-lg p-3 space-y-3">
                  {/* Source Header */}
                  <div className="flex items-center justify-between">
                    <div className="grid grid-cols-3 gap-2 flex-1">
                      <input
                        type="text"
                        placeholder="Source name (e.g., Trivy)"
                        value={source.name}
                        onChange={(e) => updateSource(index, { ...source, name: e.target.value })}
                        className="block w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100"
                      />
                      <select
                        value={source.type}
                        onChange={(e) => updateSource(index, { ...source, type: e.target.value })}
                        className="block w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100"
                      >
                        <option value="sca">SCA (Dependencies)</option>
                        <option value="sast">SAST (Code)</option>
                        <option value="container">Container</option>
                        <option value="iac">IaC (Infrastructure)</option>
                        <option value="secrets">Secrets</option>
                        <option value="license">License</option>
                        <option value="malware">Malware</option>
                      </select>
                      <input
                        type="url"
                        placeholder="Report URL (optional)"
                        value={source.url || ''}
                        onChange={(e) => updateSource(index, { ...source, url: e.target.value })}
                        className="block w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100"
                      />
                    </div>
                    <button
                      onClick={() => removeSource(index)}
                      className="ml-2 p-1 text-gray-400 hover:text-red-500 rounded transition-colors"
                      title="Remove source"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>

                  {/* Vulnerability Counts */}
                  <div className="grid grid-cols-5 gap-2">
                    {[
                      { severity: 'critical' as VulnerabilitySeverity, key: 'criticalCount' as keyof VulnerabilitySource },
                      { severity: 'high' as VulnerabilitySeverity, key: 'highCount' as keyof VulnerabilitySource },
                      { severity: 'medium' as VulnerabilitySeverity, key: 'mediumCount' as keyof VulnerabilitySource },
                      { severity: 'low' as VulnerabilitySeverity, key: 'lowCount' as keyof VulnerabilitySource },
                      { severity: 'info' as VulnerabilitySeverity, key: 'infoCount' as keyof VulnerabilitySource }
                    ].map(({ severity, key }) => (
                      <div key={severity} className="space-y-1">
                        <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 flex items-center space-x-1">
                          <span style={{ color: getSeverityColor(severity) }}>
                            {getSeverityIcon(severity)}
                          </span>
                          <span>{getSeverityLabel(severity)}</span>
                        </label>
                        <input
                          type="number"
                          min="0"
                          value={source[key] as number}
                          onChange={(e) => {
                            const value = parseInt(e.target.value) || 0
                            const updatedSource = { ...source, [key]: value }
                            // Recalculate total
                            updatedSource.totalCount = updatedSource.criticalCount + updatedSource.highCount + 
                              updatedSource.mediumCount + updatedSource.lowCount + updatedSource.infoCount
                            updateSource(index, updatedSource)
                          }}
                          className="block w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            {/* Actions */}
            <div className="flex items-center justify-end space-x-2 pt-3 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={handleCancel}
                className="btn-secondary text-sm"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                className="btn-primary text-sm flex items-center space-x-1"
              >
                <Save className="w-3 h-3" />
                <span>Save</span>
              </button>
            </div>
          </div>
        ) : (
          <div className="space-y-3">
            {/* Aggregated Vulnerability Counts */}
            <div className="grid grid-cols-5 gap-2">
              {[
                { severity: 'critical' as VulnerabilitySeverity, count: aggregatedCounts.criticalCount },
                { severity: 'high' as VulnerabilitySeverity, count: aggregatedCounts.highCount },
                { severity: 'medium' as VulnerabilitySeverity, count: aggregatedCounts.mediumCount },
                { severity: 'low' as VulnerabilitySeverity, count: aggregatedCounts.lowCount },
                { severity: 'info' as VulnerabilitySeverity, count: aggregatedCounts.infoCount }
              ].map(({ severity, count }) => (
                <div
                  key={severity}
                  className="text-center p-2 rounded border transition-all duration-200"
                  style={{
                    borderColor: getSeverityColor(severity),
                    backgroundColor: `${getSeverityColor(severity)}10`
                  }}
                >
                  <div className="flex items-center justify-center mb-1" style={{ color: getSeverityColor(severity) }}>
                    {getSeverityIcon(severity)}
                  </div>
                  <div className="text-lg font-bold" style={{ color: getSeverityColor(severity) }}>
                    {count}
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">
                    {getSeverityLabel(severity)}
                  </div>
                </div>
              ))}
            </div>

            {/* Sources List */}
            {vulnerabilitySummary?.sources && vulnerabilitySummary.sources.length > 0 && (
              <div className="space-y-2">
                <h4 className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">
                  Sources ({vulnerabilitySummary.sources.length})
                </h4>
                <div className="space-y-1">
                  {vulnerabilitySummary.sources.map((source, index) => (
                    <div key={index} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800/50 rounded text-sm">
                      <div className="flex items-center space-x-2">
                        <span 
                          className="inline-flex items-center px-2 py-1 text-xs font-medium rounded"
                          style={{
                            backgroundColor: `${getSourceTypeColor(source.type)}20`,
                            color: getSourceTypeColor(source.type)
                          }}
                        >
                          {getSourceTypeLabel(source.type)}
                        </span>
                        <span className="font-medium text-gray-900 dark:text-gray-100">
                          {source.name}
                        </span>
                        <span className="text-gray-500 dark:text-gray-400">
                          {source.totalCount} issues
                        </span>
                      </div>
                      {source.url && (
                        <a
                          href={source.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                          title="View report"
                        >
                          <ExternalLink className="w-4 h-4" />
                        </a>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Summary Info */}
            <div className="bg-gray-50 dark:bg-gray-800/50 rounded p-3">
              <div className="grid grid-cols-2 gap-3 text-center text-sm">
                <div>
                  <div className="font-bold text-gray-900 dark:text-gray-100">
                    {aggregatedCounts.totalCount}
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">Total Issues</div>
                </div>
                <div>
                  <div className="font-medium text-gray-900 dark:text-gray-100">
                    {formatDate(vulnerabilitySummary?.lastUpdated)}
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">Last Updated</div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
